<section class="demo-section" id="contact">
    <div class="container">
        <h3>ðŸ“¬ Contact Me</h3>
        <p class="section-description">
            Have questions about my work or want to collaborate? 
            I'd love to hear from you!
        </p>
        
        <div class="category-card contact-card">
            <form id="contactForm" class="contact-form" novalidate>
                <input 
                    type="text" 
                    name="website_hp" 
                    id="website_hp"
                    style="display:none !important; position: absolute; left: -9999px;" 
                    tabindex="-1" 
                    autocomplete="off"
                    aria-hidden="true">
                
                <div class="form-group">
                    <label for="contactName">Name *</label>
                    <input 
                        type="text" 
                        id="contactName" 
                        name="name"
                        placeholder="Your Name" 
                        required
                        minlength="2"
                        maxlength="100"
                        class="form-input">
                    <span class="form-error" id="nameError"></span>
                </div>
                
                <div class="form-group">
                    <label for="contactEmail">Email *</label>
                    <input 
                        type="email" 
                        id="contactEmail" 
                        name="email"
                        placeholder="your.email@example.com" 
                        required
                        maxlength="150"
                        class="form-input">
                    <span class="form-error" id="emailError"></span>
                </div>
                
                <div class="form-group">
                    <label for="contactMessage">Message *</label>
                    <textarea 
                        id="contactMessage" 
                        name="message"
                        placeholder="Type your message here..." 
                        required
                        minlength="10"
                        maxlength="5000"
                        rows="6"
                        class="form-input form-textarea"></textarea>
                    <span class="form-error" id="messageError"></span>
                    <span class="character-count" id="charCount">0 / 5000</span>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="btn-text">Send Message</span>
                    <span class="btn-icon">ðŸ“§</span>
                </button>
                
                <div id="formResponse" class="form-response" role="alert" aria-live="polite"></div>
            </form>
        </div>
    </div>
</section>

<!-- Bridge iframe: hidden relay to backend-hub (postMessage only) -->
<iframe 
    id="backend-bridge" 
    src="https://thmscmpg.github.io/backend-hub" 
    style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;"
    title="Backend communication relay"
    aria-hidden="true">
</iframe>

<style>
/* Contact Form Styles */
.contact-card {
    max-width: 600px;
    margin: 0 auto;
    padding: 30px;
}

.section-description {
    text-align: center;
    margin-bottom: 30px;
    color: #666;
    font-size: 1.1rem;
}

.contact-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.95rem;
}

.form-input {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.3s ease;
    background: #fff;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input.error {
    border-color: #f44336;
}

.form-input.success {
    border-color: #4CAF50;
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
}

.form-error {
    color: #f44336;
    font-size: 0.85rem;
    min-height: 20px;
    display: none;
}

.form-error.visible {
    display: block;
}

.character-count {
    text-align: right;
    font-size: 0.85rem;
    color: #999;
}

.submit-btn {
    padding: 14px 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

.submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.submit-btn:active:not(:disabled) {
    transform: translateY(0);
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-icon {
    font-size: 1.2rem;
}

.form-response {
    padding: 15px;
    border-radius: 8px;
    font-weight: 500;
    text-align: center;
    display: none;
    animation: slideIn 0.3s ease;
}

.form-response.visible {
    display: block;
}

.success-msg {
    background: #e8f5e9;
    color: #2e7d32;
    border: 2px solid #4CAF50;
}

.error-msg {
    background: #ffebee;
    color: #c62828;
    border: 2px solid #f44336;
}

.contact-alternatives {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.alt-contact-text {
    color: #666;
    font-size: 0.95rem;
}

.contact-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
}

.contact-link:hover {
    color: #764ba2;
    text-decoration: underline;
}

.spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .contact-card {
        padding: 20px;
    }
    
    .submit-btn {
        width: 100%;
    }
}
</style>

<script>
(function() {
    'use strict';

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // CONFIGURATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CONFIG = {
        MAX_MESSAGE_LENGTH: 5000,
        MIN_MESSAGE_LENGTH: 10,
        BRIDGE_TIMEOUT: 45000   // 45s â€” bridge has its own 120s internal timeout
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // DOM REFERENCES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const form        = document.getElementById('contactForm');
    const nameInput   = document.getElementById('contactName');
    const emailInput  = document.getElementById('contactEmail');
    const messageInput= document.getElementById('contactMessage');
    const submitBtn   = document.getElementById('submitBtn');
    const responseDiv = document.getElementById('formResponse');
    const charCount   = document.getElementById('charCount');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // VALIDATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const validators = {
        name: (value) => {
            if (!value || value.trim().length < 2) return 'Name must be at least 2 characters';
            if (value.length > 100) return 'Name is too long';
            return null;
        },
        email: (value) => {
            if (!value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Invalid email';
            if (value.length > 150) return 'Email is too long';
            return null;
        },
        message: (value) => {
            if (!value || value.trim().length < CONFIG.MIN_MESSAGE_LENGTH) return 'Message too short';
            if (value.length > CONFIG.MAX_MESSAGE_LENGTH) return 'Message too long';
            return null;
        }
    };

    function showError(inputId, message) {
        const input     = document.getElementById(inputId);
        const errorSpan = document.getElementById(inputId.replace('contact', '').toLowerCase() + 'Error');
        if (input && errorSpan) {
            input.classList.add('error');
            input.classList.remove('success');
            errorSpan.textContent = message;
            errorSpan.classList.add('visible');
        }
    }

    function clearError(inputId) {
        const input     = document.getElementById(inputId);
        const errorSpan = document.getElementById(inputId.replace('contact', '').toLowerCase() + 'Error');
        if (input && errorSpan) {
            input.classList.remove('error');
            input.classList.add('success');
            errorSpan.textContent = '';
            errorSpan.classList.remove('visible');
        }
    }

    function validateField(fieldName, value) {
        const error  = validators[fieldName](value);
        const inputId = 'contact' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
        if (error) { showError(inputId, error); return false; }
        clearError(inputId);
        return true;
    }

    // Live validation on blur
    if (nameInput)    nameInput.addEventListener('blur',  () => validateField('name', nameInput.value));
    if (emailInput)   emailInput.addEventListener('blur', () => validateField('email', emailInput.value));
    if (messageInput) {
        messageInput.addEventListener('blur',  () => validateField('message', messageInput.value));
        messageInput.addEventListener('input', () => {
            if (charCount) charCount.textContent = messageInput.value.length + ' / ' + CONFIG.MAX_MESSAGE_LENGTH;
        });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // BRIDGE COMMUNICATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /**
     * sendToBridge(payload) â†’ Promise<responseData>
     * 
     * Posts a message to the backend-hub iframe and waits for its reply.
     * Uses a string-prefixed requestId ('CF-...') so the response listener
     * can unambiguously match replies even if other messages are in flight.
     */
    function sendToBridge(payload) {
        return new Promise((resolve, reject) => {
            const iframe = document.getElementById('backend-bridge');
            if (!iframe || !iframe.contentWindow) {
                reject(new Error('Bridge iframe not found or not loaded'));
                return;
            }

            // String ID: guaranteed unique, no numeric type-coercion issues
            const requestId = 'CF-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);

            // One-shot response listener
            const handleResponse = (event) => {
                // Origin check: must come from our hub
                if (!event.origin.includes('thmscmpg.github.io') &&
                    !event.origin.includes('localhost')) return;

                // Only handle the reply meant for THIS request
                if (!event.data || event.data.id !== requestId) return;

                // Cleanup immediately
                window.removeEventListener('message', handleResponse);
                clearTimeout(safetyTimer);

                if (event.data.status === 'success') {
                    resolve(event.data.data);
                } else {
                    reject(new Error(event.data.error || 'Bridge reported a failure'));
                }
            };

            window.addEventListener('message', handleResponse);

            // Safety timeout â€” reject if bridge never replies
            const safetyTimer = setTimeout(() => {
                window.removeEventListener('message', handleResponse);
                reject(new Error('Bridge connection timed out. The backend may be cold-starting â€” please try again in a few seconds.'));
            }, CONFIG.BRIDGE_TIMEOUT);

            // Fire the message into the iframe
            iframe.contentWindow.postMessage({
                action: 'SUBMIT_CONTACT',
                id: requestId,
                payload: payload
            }, '*');
        });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // UI HELPERS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showResponse(message, isSuccess) {
        if (!responseDiv) return;
        responseDiv.textContent = message;
        responseDiv.className = 'form-response visible ' + (isSuccess ? 'success-msg' : 'error-msg');
        if (isSuccess) {
            setTimeout(() => { responseDiv.classList.remove('visible'); }, 5000);
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SUBMIT HANDLER â€” the single source of truth
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Dismiss any previous response banner
            if (responseDiv) responseDiv.classList.remove('visible');

            // 1. Validate all fields
            const v1 = validateField('name',    nameInput.value);
            const v2 = validateField('email',   emailInput.value);
            const v3 = validateField('message', messageInput.value);
            if (!v1 || !v2 || !v3) {
                showResponse('Please fix the errors above.', false);
                return;
            }

            // 2. Client-side honeypot guard â€” silently abort if filled
            if (document.getElementById('website_hp') && document.getElementById('website_hp').value.trim()) {
                console.warn('[ContactForm] Honeypot triggered â€” submission discarded.');
                return;
            }

            // 3. UI â†’ Loading state
            submitBtn.disabled = true;
            const btnText     = submitBtn.querySelector('.btn-text');
            const originalText = btnText ? btnText.textContent : 'Send Message';
            if (btnText) btnText.textContent = 'Sending...';

            // 4. Assemble payload
            const formData = {
                name:       nameInput.value.trim(),
                email:      emailInput.value.trim(),
                message:    messageInput.value.trim()
            };

            try {
                // 5. Route through the bridge â†’ backend-hub â†’ Render
                const data = await sendToBridge(formData);

                // 6. Success
                showResponse(data.message || 'Message sent successfully!', true);
                form.reset();
                [nameInput, emailInput, messageInput].forEach(el => el.classList.remove('success'));
                if (charCount) charCount.textContent = '0 / ' + CONFIG.MAX_MESSAGE_LENGTH;

            } catch (error) {
                console.error('[ContactForm] Bridge error:', error);
                showResponse(error.message || 'Failed to send message. Please try again.', false);

            } finally {
                // 7. Restore button
                submitBtn.disabled = false;
                if (btnText) btnText.textContent = originalText;
            }
        });
    }

    console.log('âœ“ Contact form initialized (bridge-routed)');
})();
</script>
