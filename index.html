<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Bridge Hub</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1a1c23 0%, #131519 100%);
            --card-bg: #24262d;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-color: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --terminal-bg: #0f1115;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: var(--text-primary); min-height: 100vh; padding: 20px; display: flex; justify-content: center; }
        .dashboard { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); border-radius: 12px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .header-card { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-color); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; }
        .stat-value { font-size: 1.8rem; font-weight: 700; }

        .terminal-window { height: 350px; background: var(--terminal-bg); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.85rem; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); display: grid; grid-template-columns: 80px 100px 1fr; gap: 10px; }
        .log-time { color: var(--text-secondary); }
        .log-source { color: var(--accent-color); font-weight: bold; }
        .log-msg { word-break: break-all; color: #d1d5db; }
        .log-entry.error .log-msg { color: var(--error); }
        
        pre { background: #15171c; padding: 15px; border-radius: 6px; color: #a5b3ce; font-size: 0.8rem; overflow-x: auto; white-space: pre-wrap; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 8px; color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card header-card">
        <h1><span class="dot"></span> DevOps Bridge Hub</h1>
        <div id="api-status" style="color: var(--text-secondary); font-size: 0.9rem;">API: Checking...</div>
    </div>

    <div class="main-content">
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Messages</div>
                <div class="stat-value" id="msg-count">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Uptime</div>
                <div class="stat-value" id="uptime">00:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Status</div>
                <div class="stat-value" style="color: var(--success); font-size: 1.2rem;">READY</div>
            </div>
        </div>

        <div class="card">
            <h2>üì° Network Traffic</h2>
            <div class="terminal-window" id="terminal">
                <div class="log-entry"><span class="log-time">System</span><span class="log-source">INIT</span><span class="log-msg">Bridge active. Listening for cross-origin requests...</span></div>
            </div>
        </div>

        <div class="card">
            <h2>üîç Last Payload</h2>
            <pre id="json-viewer">// No data received yet...</pre>
        </div>
    </div>

    <div class="sidebar">
        <div class="card">
            <h2>Configuration</h2>
            <p style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">Backend Target:</p>
            <code id="current-url" style="font-size: 0.7rem; display: block; margin-bottom: 15px; color: var(--accent-color);"></code>
            <button class="btn btn-outline" onclick="location.reload()">Refresh Hub</button>
            <button class="btn btn-outline" onclick="clearLogs()">Clear Console</button>
        </div>
    </div>
</div>

<script>
    /**
     * BRIDGE LOGIC & UI INTEGRATION
     */
    const CONFIG = {
        BACKEND_URL: 'https://aura-mf-backend.onrender.com',
        TIMEOUT: 30000
    };

    const state = { count: 0, startTime: Date.now() };
    document.getElementById('current-url').innerText = CONFIG.BACKEND_URL;

    // --- UI HELPERS ---
    function addLog(source, message, type = 'info') {
        const terminal = document.getElementById('terminal');
        const row = document.createElement('div');
        row.className = `log-entry ${type}`;
        row.innerHTML = `
            <span class="log-time">${new Date().toLocaleTimeString()}</span>
            <span class="log-source">${source}</span>
            <span class="log-msg">${message}</span>
        `;
        terminal.appendChild(row);
        terminal.scrollTop = terminal.scrollHeight;
        
        state.count++;
        document.getElementById('msg-count').innerText = state.count;
    }

    function clearLogs() {
        document.getElementById('terminal').innerHTML = '';
        state.count = 0;
        document.getElementById('msg-count').innerText = '0';
    }

    // --- THE BRIDGE FUNCTIONALITY ---
    window.addEventListener('message', async (event) => {
        // Security Check
        if (!event.origin.includes('github.io') && !event.origin.includes('localhost')) return;

        const { action, payload, id } = event.data;
        if (!action || !id) return;

        addLog('INBOUND', `${action} request received from ${event.origin}`);
        document.getElementById('json-viewer').textContent = JSON.stringify(payload, null, 2);

        // Handle the Logic
        if (action === 'ENQUEUE_CONTACT' || action === 'SUBMIT_CONTACT') {
            // 1. Immediate ACK (Asynchronous Pattern)
            event.source.postMessage({ id, status: 'success', data: { message: "Queued" } }, event.origin);
            addLog('BRIDGE', 'Sent ACK to frontend (Async)');

            // 2. Background Processing
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/contact`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) addLog('BACKEND', 'Successfully delivered to Render.', 'success');
                else throw new Error(`Status ${response.status}`);
            } catch (err) {
                addLog('ERROR', `Background delivery failed: ${err.message}`, 'error');
            }
        } 
        
        else if (action === 'HEALTH_CHECK') {
            const start = Date.now();
            try {
                await fetch(`${CONFIG.BACKEND_URL}/api/health`);
                const lat = Date.now() - start;
                event.source.postMessage({ id, status: 'success', latency: lat }, event.origin);
                addLog('SYSTEM', `Health check: ${lat}ms`);
            } catch (err) {
                event.source.postMessage({ id, status: 'error' }, event.origin);
            }
        }
    });

    // Uptime counter
    setInterval(() => {
        const sec = Math.floor((Date.now() - state.startTime) / 1000);
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = (sec % 60).toString().padStart(2, '0');
        document.getElementById('uptime').innerText = `${m}:${s}`;
    }, 1000);

    // Initial Health Check
    (async () => {
        try {
            await fetch(`${CONFIG.BACKEND_URL}/api/health`);
            document.getElementById('api-status').innerText = "API: ONLINE";
            document.getElementById('api-status').style.color = "var(--success)";
        } catch (e) {
            document.getElementById('api-status').innerText = "API: OFFLINE";
            document.getElementById('api-status').style.color = "var(--error)";
        }
    })();
</script>
</body>
</html>
